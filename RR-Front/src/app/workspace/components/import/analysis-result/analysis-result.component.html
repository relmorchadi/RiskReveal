<div *ngIf="data?.analysis?.length>0" class="body-wrap-body">
  <div class="body-wrapper">
    <div class="body-wrapper-header">
      <div class="body-wrapper-header-left">
        <hr>
        <div class="header-title">Analysis Results</div>
      </div>
      <div class="body-wrapper-header-right-summary">
        <!--        <ng-container>-->
        <!--          <button class="a-buttons-outlined-mini" style="margin: 0 10px 0 0" *ngIf="state.collapse.collapseAnalysis"> ADD TO CALIBRATION-->
        <!--          </button>-->
        <!--          <button class="a-buttons-outlined-mini" (click)="setLinkingState()" *ngIf="state.collapse.collapseAnalysis"> LINKING-->
        <!--          </button>-->
        <!--        </ng-container>-->
        <div class="body-wrapper-header-right">
          <i (click)="isCollapsed= !isCollapsed"
             [ngClass]="{'icon-keyboard_arrow_down_24px': !isCollapsed, 'icon-keyboard_arrow_up_24px':  isCollapsed}"></i>
        </div>
      </div>
    </div>
    <div class="summary-info" *ngIf="!isCollapsed">
      <!--      <p-contextMenu appendTo="body" #cmR [model]="itemCm"></p-contextMenu>-->
      <div class="menu-icon-wrap">
        <nz-dropdown [nzTrigger]="'hover'" [nzPlacement]="'bottomRight'">
          <a style="max-height: 28px;display: flex;" nz-dropdown>
            <i class="icon-settings_24px"></i>
          </a>
          <ul nz-menu style="font-size: 12px">
            <li nz-menu-item>Reset Sort</li>
            <li nz-menu-item>Reset Filters</li>
            <li nz-menu-item>Reset Sort/Filters</li>
            <li nz-menu-divider></li>
            <li nz-menu-item>Manage Columns</li>
            <li nz-menu-divider></li>
            <li nz-menu-item>Unselect All</li>
          </ul>
        </nz-dropdown>
      </div>
      <p-table [columns]="scrollableColsResults" [frozenColumns]="frozenColsResults"
               [value]="data.analysis" [scrollHeight]="'175px'"
               [resizableColumns]="true" columnResizeMode="expand"
               #rt [scrollable]="true" frozenWidth="445px">
        <ng-template pTemplate="colgroup" let-columns>
          <colgroup>
            <ng-container *ngFor="let col of columns">
              <ng-container *ngIf="col.visible">
                <col [ngStyle]="{'width': col.width}">
              </ng-container>
            </ng-container>
          </colgroup>
        </ng-template>
        <ng-template pTemplate="header" let-columns>
          <tr>
            <ng-container *ngFor="let col of columns">
              <th *ngIf="col.visible" pResizableColumn>
                <ng-container *ngIf="col.type === 'selection'">
                  <!--                  <label style="margin-top:20px" nz-checkbox (ngModelChange)="updateAllChecked($event, 'results')"-->
                  <!--                         [nzIndeterminate]="true"></label>-->
                  <!--                            <i style="cursor: pointer;" nz-icon nzType="down" nzTheme="outline"></i>-->
                </ng-container>
                <div style="white-space: nowrap;" *ngIf="!col.filtered">{{col.header}}</div>
                <div style="white-space: nowrap;"
                     *ngIf="col.filtered && col.type !== 'icon' && col.type !== 'check'">
                  {{col.header}}
                  <ng-container [ngSwitch]="col?.sorting">
                    <i (click)="sortChange(col?.field, col?.sorting, 'Analysis')" *ngSwitchCase="'asc'"
                       class="icon-keyboard_arrow_up_24px" style="font-size: 1.4em;"></i>
                    <i (click)="sortChange(col?.field, col?.sorting, 'Analysis')" *ngSwitchCase="'desc'"
                       class="icon-keyboard_arrow_down_24px" style="font-size: 1.4em;"></i>
                    <i (click)="sortChange(col?.field, col?.sorting, 'Analysis')" *ngSwitchDefault
                       class="icon-direction" style="font-size: 1.4em;"></i>
                  </ng-container>
                  <div class="search-bar-table">
                    <i class="fa fa-search" style="margin: 6px 4px 4px 6px"></i>
                    <input pInputText type="text"
                           (input)="rt.filter($event.target.value, col.field, col.filterMatchMode)">
                  </div>
                </div>
                <div *ngIf="col.type === 'check'">
                  <i [nzTitle]="col.header" nzPlacement="top" nz-tooltip style="font-size: 20px;"
                     [ngClass]="col.icon"></i>
                </div>
              </th>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-i="rowIndex" let-rowData let-columns="columns">
          <tr [pContextMenuRow]="rowData">
            <ng-container *ngFor="let col of columns">
              <th *ngIf="col.visible && !col.edit" class="ui-resizable-column"
                  [ngClass]="{'selected-item': rowData?.selected}">
                <div class="" *ngIf="col.type === 'selection'">
                  <label nz-checkbox (ngModelChange)="updateRowData(col.field, $event, i)"
                         [ngModel]="rowData.selected"></label>
                </div>
                <div class="text-data" *ngIf="col.type === 'scan'"><i class="icon-loop_24px"></i></div>
                <div class="text-data" *ngIf="col.type === 'progress'">
                  <nz-progress [nzPercent]="rowData.status" [ngClass]="{'hidden-text': rowData.status < 100 }"
                               [nzWidth]="20" nzType="circle"></nz-progress>
                </div>
                <div class="text-data" (click)="openFinancialP(rowData)" [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'multiple'">
                  <span>{{rowData?.financialPerspectives?.length}}</span>
                  <!--                  <span nzPlacement="top" nz-tooltip-->
                  <!--                        *ngIf="rowData?.financialPerspective?.length == 0">Nan</span>-->
                  <!--                  <ng-template #infoFP>-->
                  <!--                    <div class="popover-menu">-->
                  <!--                      <ul style="margin-bottom: 0">-->
                  <!--                        <li *ngFor="let item of rowData?.financialPerspective" style="border: none;">-->
                  <!--                            <span style="display: flex; width: 100%;">-->
                  <!--                              <span style="display: inline-flex; width: 23px;">{{item}}</span>: {{item}}</span>-->
                  <!--                        </li>-->
                  <!--                      </ul>-->
                  <!--                    </div>-->
                  <!--                  </ng-template>-->
                </div>
                <div class="text-data" (click)="selectRows(rowData, i)"
                     [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'number'">
                  <input *ngIf="col.field=='unitMultiplier'; else formattedNumber" type="number" class="col-edit-input"
                         [(ngModel)]="rowData[col.field]" (ngModelChange)="updateRowData(col.field, $event, i)">
                  <ng-template #formattedNumber>
                    <span>{{rowData[col.field] | number: '1.2-2'}}</span>
                  </ng-template>
                </div>
                <div class="text-data" (click)="selectRows(rowData, i)"
                     [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'percentage'">
                  <input *ngIf="col.field=='proportion'; else formattedNumber" type="number" class="col-edit-input"
                         [(ngModel)]="rowData[col.field]" (ngModelChange)="updateRowData(col.field, $event,i)">
                  <ng-template #formattedNumber>
                    <span>{{rowData[col.field] | number: '1.2-2'}} % </span>
                  </ng-template>

                </div>
                <div class="text-data" (click)="selectRows(rowData, i)"
                     [ngStyle]="{'font-weight': col.field === 'number' ? 'bold' : '500'}"
                     [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'text'"><span>{{rowData[col.field]}}</span></div>
                <div class="text-data" style="font-weight: 500"
                     *ngIf="col.type === 'Rp' || col.type === 'Ob'"
                     (click)="overrideRegionPerilOccurrenceBasis(rowData, col.type,i)">
                    <span class="highlighted-change">
                      {{rowData[col.field]}}
                    </span>
                </div>
                <div class="text-data" (click)="showOverridePEQTDialog=true" *ngIf="col.type === 'Peqt'">
                    <span class="highlighted-change">
                      <span *ngIf=" (rowData.targetRaps||[]).length > 0; else noSelectedPeqts" nz-tooltip [nzTitle]="peqtInfo">
                        {{rowData.targetRaps.length}}
                      </span>
                      <ng-template #peqtInfo>
                        <div class="popover-menu">
                          <ul style="margin-bottom: 0">
                            <ng-container *ngFor="let item of rowData?.targetRaps">
                              <li *ngIf="item.selected">{{item.targetRapCode}}</li>
                            </ng-container>
                          </ul>
                        </div>
                      </ng-template>
                    </span>
                    <ng-template #noSelectedPeqts>
                      <span>
                          <i class="icon-exclamation-triangle"></i>
                      </span>
                    </ng-template>
                </div>
                <div class="text-data" [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'date'"><span>{{rowData[col.field] | date:'dd/MM/yyyy'}}</span></div>
                <div style="padding-left: 10px;" *ngIf="col.type === 'check'">
                  <label nz-checkbox [(ngModel)]="rowData[col.field]"></label>
                </div>
              </th>
              <ng-container *ngIf="col.edit">
                <th pEditableColumn *ngIf="col.field === 'targetCurrency'"
                    [ngClass]="{'selected-item': rowData?.selected}">
                  <p-cellEditor>
                    <ng-template pTemplate="input">
                      <nz-select
                        style="width: 100%"
                        (ngModelChange)="updateRowData(col.field, $event, i)"
                        [ngModel]="rowData.targetCurrency"
                        nzShowSearch
                        class="a-dropdown-small input-wrapper"
                        nzPlaceHolder="TAG CURRENCY"
                      >
                        <nz-option *ngFor="let c of refs?.currencies" [nzLabel]="c.label"
                                   [nzValue]="c.value"></nz-option>
                      </nz-select>
                    </ng-template>
                    <ng-template pTemplate="output">
                      <div class="text-data highlight-temp"><span>{{rowData.targetCurrency}}</span></div>
                    </ng-template>
                  </p-cellEditor>
                </th>
                <!--                <th pEditableColumn *ngIf="col.field === 'targetRap'"-->
                <!--                    [ngClass]="{'selected-item': rowData?.selected}">-->
                <!--                  <p-cellEditor>-->
                <!--                    <ng-template pTemplate="input">-->
                <!--                      <nz-select-->
                <!--                        style="width: 100%"-->
                <!--                        (ngModelChange)="updateTargetRap($event, rowData)"-->
                <!--                        [ngModel]="rowData.targetRap"-->
                <!--                        nzShowSearch-->
                <!--                        class="a-dropdown-small input-wrapper"-->
                <!--                        nzPlaceHolder="TAG TARGET RAP CODE"-->
                <!--                      >-->
                <!--                        <nz-option *ngFor="let tr of refs?.targetRaps" [nzLabel]="tr" [nzValue]="tr"></nz-option>-->
                <!--                      </nz-select>-->
                <!--                    </ng-template>-->
                <!--                    <ng-template pTemplate="output">-->
                <!--                      <div class="text-data highlight-temp"><span>{{rowData.targetRap}}</span></div>-->
                <!--                    </ng-template>-->
                <!--                  </p-cellEditor>-->
                <!--                </th>-->
              </ng-container>
            </ng-container>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<override-region-peril-dialog *ngIf="showOverrideRpDialog" [visible]="showOverrideRpDialog" [data]="data.analysis"
                              [regionPerilByAnalysis]="data.regionPerilsByAnalysis"
                              (close)="showOverrideRpDialog=false"
                              (override)="overrideRegionPeril($event)">
</override-region-peril-dialog>


<financial-persp-selection-dialog *ngIf="showSelectFinancialPerspDialog" [visible]="showSelectFinancialPerspDialog"
                                  [data]="data" (close)="showSelectFinancialPerspDialog=false"
                                  (loadEpCurves)="loadSourceEpCurveHeaders($event)"
                                  (override)="overrideFinancialPersp($event)"
></financial-persp-selection-dialog>

<override-peqt-dialog *ngIf="showOverridePEQTDialog" [visible]="showOverridePEQTDialog"
                      [data]="{analysis: data.analysis, targetRaps: data.targetRaps}"
                      (loadTargetRaps)="loadTargetRaps($event)" (override)="overridePEQTs($event)"
                      (close)="closePEQTOverrideDialog()">
</override-peqt-dialog>


<override-occurence-basis-dialog [visible]="showOverrideOccurrenceBasisDialog"
  (override)="overrideOccurrenceBasis($event)"
  (close)="showOverrideOccurrenceBasisDialog=false">

</override-occurence-basis-dialog>

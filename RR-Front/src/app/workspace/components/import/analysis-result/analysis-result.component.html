<div *ngIf="analysis?.length>0" class="body-wrap-body">
  <div class="body-wrapper">
    <div class="body-wrapper-header">
      <div class="body-wrapper-header-left">
        <hr>
        <div class="header-title">Analysis Results</div>
      </div>
      <div class="body-wrapper-header-right-summary">
        <!--        <ng-container>-->
        <!--          <button class="a-buttons-outlined-mini" style="margin: 0 10px 0 0" *ngIf="state.collapse.collapseAnalysis"> ADD TO CALIBRATION-->
        <!--          </button>-->
        <!--          <button class="a-buttons-outlined-mini" (click)="setLinkingState()" *ngIf="state.collapse.collapseAnalysis"> LINKING-->
        <!--          </button>-->
        <!--        </ng-container>-->
        <div class="body-wrapper-header-right">
          <i (click)="isCollapsed= !isCollapsed"
             [ngClass]="{'icon-keyboard_arrow_down_24px': !isCollapsed, 'icon-keyboard_arrow_up_24px':  isCollapsed}"></i>
        </div>
      </div>
    </div>
    <div class="summary-info" *ngIf="!isCollapsed">
      <!--      <p-contextMenu appendTo="body" #cmR [model]="itemCm"></p-contextMenu>-->
      <div class="menu-icon-wrap">
        <nz-dropdown [nzTrigger]="'hover'" [nzPlacement]="'bottomRight'">
          <a style="max-height: 28px;display: flex;" nz-dropdown>
            <i class="icon-settings_24px"></i>
          </a>
          <ul nz-menu style="font-size: 12px">
            <li nz-menu-item>Reset Sort</li>
            <li nz-menu-item>Reset Filters</li>
            <li nz-menu-item>Reset Sort/Filters</li>
            <li nz-menu-divider></li>
            <li nz-menu-item>Manage Columns</li>
            <li nz-menu-divider></li>
            <li nz-menu-item>Unselect All</li>
          </ul>
        </nz-dropdown>
      </div>
      <p-table [columns]="scrollableColsResults" [frozenColumns]="frozenColsResults"
               [value]="analysis" [scrollHeight]="'175px'"
               [resizableColumns]="true" columnResizeMode="expand"
               #rt [scrollable]="true" frozenWidth="445px">
        <ng-template pTemplate="colgroup" let-columns>
          <colgroup>
            <ng-container *ngFor="let col of columns">
              <ng-container *ngIf="col.visible">
                <col [ngStyle]="{'width': col.width}">
              </ng-container>
            </ng-container>
          </colgroup>
        </ng-template>
        <ng-template pTemplate="header" let-columns>
          <tr>
            <ng-container *ngFor="let col of columns">
              <th *ngIf="col.visible" pResizableColumn>
                <ng-container *ngIf="col.type === 'selection'">
                  <label style="margin-top:20px" nz-checkbox (ngModelChange)="updateAllChecked($event, 'results')"
                         [nzIndeterminate]="true"></label>
                  <!--                            <i style="cursor: pointer;" nz-icon nzType="down" nzTheme="outline"></i>-->
                </ng-container>
                <div style="white-space: nowrap;" *ngIf="!col.filtered">{{col.header}}</div>
                <div style="white-space: nowrap;"
                     *ngIf="col.filtered && col.type !== 'icon' && col.type !== 'check'">
                  {{col.header}}
                  <ng-container [ngSwitch]="col?.sorting">
                    <i (click)="sortChange(col?.field, col?.sorting, 'Analysis')" *ngSwitchCase="'asc'"
                       class="icon-keyboard_arrow_up_24px" style="font-size: 1.4em;"></i>
                    <i (click)="sortChange(col?.field, col?.sorting, 'Analysis')" *ngSwitchCase="'desc'"
                       class="icon-keyboard_arrow_down_24px" style="font-size: 1.4em;"></i>
                    <i (click)="sortChange(col?.field, col?.sorting, 'Analysis')" *ngSwitchDefault
                       class="icon-direction" style="font-size: 1.4em;"></i>
                  </ng-container>
                  <div class="search-bar-table">
                    <i class="fa fa-search" style="margin: 6px 4px 4px 6px"></i>
                    <input pInputText type="text"
                           (input)="rt.filter($event.target.value, col.field, col.filterMatchMode)">
                  </div>
                </div>
                <div *ngIf="col.type === 'check'">
                  <i [nzTitle]="col.header" nzPlacement="top" nz-tooltip style="font-size: 20px;"
                     [ngClass]="col.icon"></i>
                </div>
              </th>
            </ng-container>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-i="rowIndex" let-rowData let-columns="columns">
          <tr [pContextMenuRow]="rowData">
            <ng-container *ngFor="let col of columns">
              <th *ngIf="col.visible && !col.edit" class="ui-resizable-column"
                  [ngClass]="{'selected-item': rowData?.selected}">
                <div class="" *ngIf="col.type === 'selection'">
                  <label nz-checkbox (ngModelChange)="updateRowData(col.field, $event, i)"
                         [ngModel]="rowData.selected"></label>
                </div>
                <div class="text-data" *ngIf="col.type === 'scan'"><i class="icon-loop_24px"></i></div>
                <div class="text-data" *ngIf="col.type === 'progress'">
                  <nz-progress [nzPercent]="rowData.status" [ngClass]="{'hidden-text': rowData.status < 100 }"
                               [nzWidth]="20" nzType="circle"></nz-progress>
                </div>
                <div class="text-data" (click)="openFinancialP(rowData)" [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'multiple'">
                  <span>{{rowData?.financialPerspective}}</span>
<!--                  <span nzPlacement="top" nz-tooltip-->
<!--                        *ngIf="rowData?.financialPerspective?.length == 0">Nan</span>-->
                  <!--                  <ng-template #infoFP>-->
                  <!--                    <div class="popover-menu">-->
                  <!--                      <ul style="margin-bottom: 0">-->
                  <!--                        <li *ngFor="let item of rowData?.financialPerspective" style="border: none;">-->
                  <!--                            <span style="display: flex; width: 100%;">-->
                  <!--                              <span style="display: inline-flex; width: 23px;">{{item}}</span>: {{item}}</span>-->
                  <!--                        </li>-->
                  <!--                      </ul>-->
                  <!--                    </div>-->
                  <!--                  </ng-template>-->
                </div>
                <div class="text-data" (click)="selectRows(rowData, i)"
                     [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'number'">
                  <input *ngIf="col.field=='unitMultiplier'; else formattedNumber" type="number" class="col-edit-input"
                         [(ngModel)]="rowData[col.field]" (ngModelChange)="updateRowData(col.field, $event, i)">
                  <ng-template #formattedNumber>
                    <span>{{rowData[col.field] | number: '1.2-2'}}</span>
                  </ng-template>
                </div>
                <div class="text-data" (click)="selectRows(rowData, i)"
                     [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'percentage'">
                  <input *ngIf="col.field=='proportion'; else formattedNumber" type="number" class="col-edit-input"
                         [(ngModel)]="rowData[col.field]" (ngModelChange)="updateRowData(col.field, $event,i)">
                  <ng-template #formattedNumber>
                    <span>{{rowData[col.field] | number: '1.2-2'}} % </span>
                  </ng-template>

                </div>
                <div class="text-data" (click)="selectRows(rowData, i)"
                     [ngStyle]="{'font-weight': col.field === 'number' ? 'bold' : '500'}"
                     [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'text'"><span>{{rowData[col.field]}}</span></div>
                <div class="text-data" style="font-weight: 500"
                     *ngIf="col.type === 'Rp' || col.type === 'Ob'"
                     (click)="updateRow(rowData, col.type)">
                    <span class="highlighted-change">
                      {{rowData[col.field]}}
                    </span>
                </div>
                <div class="text-data" (click)="openPEQTModal(i)" *ngIf="col.type === 'Peqt'">
                    <span class="highlighted-change">
                      <span nz-tooltip [nzTitle]="peqtInfo">
                        {{rowData[col.field]}}
                      </span>
                      <ng-template #peqtInfo>
                        <div class="popover-menu">
                          <ul style="margin-bottom: 0">
                            <ng-container *ngFor="let item of rowData.peqt">
                              <li *ngIf="item.selected">{{item.title}}</li>
                            </ng-container>
                          </ul>
                        </div>
                      </ng-template>
                    </span>
                  <span *ngIf="!rowData[col.field]">
                        <i class="icon-exclamation-triangle"></i>
                    </span>
                </div>
                <div class="text-data" [ngClass]="{'highlight-temp': col.highlight}"
                     *ngIf="col.type === 'date'"><span>{{rowData[col.field] | date:'dd/MM/yyyy'}}</span></div>
                <div style="padding-left: 10px;" *ngIf="col.type === 'check'">
                  <label nz-checkbox [(ngModel)]="rowData[col.field]"></label>
                </div>
              </th>
              <ng-container *ngIf="col.edit">
                <th pEditableColumn *ngIf="col.field === 'targetCurrency'"
                    [ngClass]="{'selected-item': rowData?.selected}">
                  <p-cellEditor>
                    <ng-template pTemplate="input">
                      <nz-select
                        style="width: 100%"
                        (ngModelChange)="updateRowData(col.field, $event, i)"
                        [ngModel]="rowData.targetCurrency"
                        nzShowSearch
                        class="a-dropdown-small input-wrapper"
                        nzPlaceHolder="TAG CURRENCY"
                      >
                        <nz-option *ngFor="let c of refs?.currencies" [nzLabel]="c.label"
                                   [nzValue]="c.value"></nz-option>
                      </nz-select>
                    </ng-template>
                    <ng-template pTemplate="output">
                      <div class="text-data highlight-temp"><span>{{rowData.targetCurrency}}</span></div>
                    </ng-template>
                  </p-cellEditor>
                </th>
                <!--                <th pEditableColumn *ngIf="col.field === 'targetRap'"-->
                <!--                    [ngClass]="{'selected-item': rowData?.selected}">-->
                <!--                  <p-cellEditor>-->
                <!--                    <ng-template pTemplate="input">-->
                <!--                      <nz-select-->
                <!--                        style="width: 100%"-->
                <!--                        (ngModelChange)="updateTargetRap($event, rowData)"-->
                <!--                        [ngModel]="rowData.targetRap"-->
                <!--                        nzShowSearch-->
                <!--                        class="a-dropdown-small input-wrapper"-->
                <!--                        nzPlaceHolder="TAG TARGET RAP CODE"-->
                <!--                      >-->
                <!--                        <nz-option *ngFor="let tr of refs?.targetRaps" [nzLabel]="tr" [nzValue]="tr"></nz-option>-->
                <!--                      </nz-select>-->
                <!--                    </ng-template>-->
                <!--                    <ng-template pTemplate="output">-->
                <!--                      <div class="text-data highlight-temp"><span>{{rowData.targetRap}}</span></div>-->
                <!--                    </ng-template>-->
                <!--                  </p-cellEditor>-->
                <!--                </th>-->
              </ng-container>
            </ng-container>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<p-dialog
  [visible]="showUpdatePEQTModal"
  [closable]="false"
  styleClass="m-dialog-modal-target-rap"
  [modal]="true"
  [autoZIndex]="false"
  [responsive]="true"
  (onShow)="onPEQTModalShow()"
>
  <p-header>
    <div class="header">
      <h6>Target Rap Selection</h6>
      <i style="cursor: pointer" (click)="showUpdatePEQTModal = false" class="icon-close_24px"></i>
    </div>
  </p-header>
  <div class="input-group-modal" style="width:100%; padding:0;">
    <div class="row-list">
    </div>
  </div>
  <div style="display: flex; justify-content: space-between">
    <div class="fp-options-wrapper">
      <span class="subtitle-2">Target Rap</span>
      <div class="menu-icon-wrap" style="position: absolute;top: 20px;font-size: 20px;right: 29px;">
        <nz-dropdown [nzTrigger]="'hover'" [nzPlacement]="'bottomRight'">
          <a style="max-height: 28px;display: flex;" nz-dropdown>
            <i class="icon-settings_24px"></i>
          </a>
          <ul nz-menu style="font-size: 12px">
            <li nz-menu-item>Reset Sort</li>
            <li nz-menu-item>Reset Filters</li>
            <li nz-menu-item>Reset Sort/Filters</li>
            <li nz-menu-divider></li>
            <li nz-menu-item>Manage Columns</li>
            <li nz-menu-divider></li>
            <li nz-menu-item>Unselect All</li>
          </ul>
        </nz-dropdown>
      </div>
      <div class="popover-menu">
              <div class="popover-menu absolute-menu">
                <div class="summary-info" >
                  <p-table [columns]="targetRapDataTable" [dataKey]="'id'"
                           [resizableColumns]="true" [scrollHeight]="'250px'"
                           [value]="refs.targetRaps" #peqtdatat [scrollable]="true">
                    <ng-template pTemplate="colgroup" let-columns>
                      <colgroup>
                        <ng-container *ngFor="let col of columns">
                          <col [ngStyle]="{'width': col.width}">
                        </ng-container>
                      </colgroup>
                    </ng-template>
                    <ng-template pTemplate="header" let-columns>
                      <tr>
                        <ng-container *ngFor="let col of columns">
                          <th *ngIf="col.visible" pResizableColumn>
                            <ng-container *ngIf="col.type === 'select'">
<!--                              <label style="margin-top:20px" nz-checkbox [ngModel]="getCheckedValue(child.selectedItems)" (ngModelChange)="updateAllCheckedPeqt($event, child.selectedItems)"-->
<!--                                     [nzIndeterminate]="getIndeterminateValue(child.selectedItems)"></label>-->
                            </ng-container>
                            <div style="white-space: nowrap;" *ngIf="col.type !== 'icon' && col.type !== 'check'">{{col.header}}
                              <p-sortIcon [field]="col.field" ariaLabel="Activate to sort" *ngIf="col.sorting"
                                          ariaLabelAsc="Activate to sort in ascending order"
                                          ariaLabelDesc="Activate to sort in descending order"></p-sortIcon>
                              <ng-container *ngIf="col.filtered">
                                <div class="search-bar-table">
                                  <i class="fa fa-search" style="margin: 6px 4px 4px 6px"></i>
                                  <input pInputText type="text"
                                         (input)="peqtdatat.filter($event.target.value, col.field, col.filterMatchMode)">
                                </div>
                              </ng-container>
                            </div>
                          </th>
                        </ng-container>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-i="rowIndex" let-rowData let-columns="columns">
                      <tr>
                        <ng-container *ngFor="let col of columns">
                          <td *ngIf="col.visible && !col.edit" [ngClass]="{'selected-item': rowData?.selected}">
                            <div class="" *ngIf="col.type === 'select'">
                              <label nz-checkbox [(ngModel)]="rowData.selected"></label>
                            </div>
                            <div (click)="rowData.selected = true" *ngIf="col.type === 'text'">{{rowData[col.field]}}</div>
                          </td>
                        </ng-container>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
                <!--                  <ul>
                                    <li *ngFor="let innerItem of child.selectedItems">
                                      <label nz-checkbox style="margin-right: 5px"
                                             (ngModelChange)="changeInnerPeqt(parent, child, innerItem.title, innerItem.selected)"
                                             [(ngModel)]="innerItem.selected">
                                        {{innerItem.title}}
                                      </label>
                                    </li>
                                  </ul>-->
              </div>
      </div>
    </div>
  </div>
  <p-footer>
    <button (click)="showUpdatePEQTModal = false" class="a-button-text-cancel-mini">CANCEL</button>
    <button (click)="updatePEQT()" class="a-buttons-contained-mini">SAVE
    </button>
  </p-footer>
</p-dialog>

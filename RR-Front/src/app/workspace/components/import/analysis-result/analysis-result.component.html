<div *ngIf="data?.analysis?.length>0" class="body-wrap-body">
    <div class="body-wrapper">
        <div class="body-wrapper-header">
            <div class="body-wrapper-header-left">
                <hr>
                <div class="header-title">Analysis Results
                    <nz-badge
                            style="float: right"
                            [nzCount]="data?.analysis?.length"
                            [nzStyle]="{ backgroundColor: '#fff', color: '#999', boxShadow: '0 0 0 1px #d9d9d9 inset' }"
                    ></nz-badge>
                </div>
            </div>
            <div class="body-wrapper-header-right-summary">
                <!--        <ng-container>-->
                <!--          <button class="a-buttons-outlined-mini" style="margin: 0 10px 0 0" *ngIf="state.collapse.collapseAnalysis"> ADD TO CALIBRATION-->
                <!--          </button>-->
                <!--          <button class="a-buttons-outlined-mini" (click)="setLinkingState()" *ngIf="state.collapse.collapseAnalysis"> LINKING-->
                <!--          </button>-->
                <!--        </ng-container>-->
                <div class="body-wrapper-header-right">
                    <i (click)="isCollapsed= !isCollapsed"
                       [ngClass]="{'icon-keyboard_arrow_down_24px': !isCollapsed, 'icon-keyboard_arrow_up_24px':  isCollapsed}"></i>
                </div>
            </div>
        </div>
        <div class="summary-info" *ngIf="!isCollapsed">
            <!--      <p-contextMenu appendTo="body" #cmR [model]="itemCm"></p-contextMenu>-->
            <div class="menu-icon-wrap">
                <nz-dropdown [nzTrigger]="'hover'" [nzPlacement]="'bottomRight'">
                    <a style="max-height: 28px;display: flex;" nz-dropdown>
                        <i class="icon-settings_24px"></i>
                    </a>
                    <ul nz-menu style="font-size: 12px">
                        <li nz-menu-item (click)="resetSort()">Reset Sort</li>
                        <li nz-menu-item>Reset Filters</li>
                        <li nz-menu-item>Reset Sort/Filters</li>
                        <li nz-menu-divider></li>
                        <li nz-menu-item>Manage Columns</li>
                        <li nz-menu-divider></li>
                        <li nz-menu-item>Unselect All</li>
                    </ul>
                </nz-dropdown>
            </div>
            <p-table [columns]="scrollableColsResults" [frozenColumns]="frozenColsResults"
                     [value]="data.analysis | tableFilter:filter" [scrollHeight]="'175px'"
                     (selectionChange)="getSelection($event)"
                     selectionMode="multiple" [metaKeySelection]="true" [(selection)]="selectedRows"
                     [(contextMenuSelection)]="contextSelectedItem"
                     [contextMenu]="cmR"
                     syncScroll
                     [class]="'analysis-result-table'"
                     [classIdentifier]="'analysis-result-table'"
                     [rowTrackBy]="trackBy"
                     [resizableColumns]="true" columnResizeMode="expand"
                     #analysisResultTable [scrollable]="true" frozenWidth="445px">
                <ng-template pTemplate="colgroup" let-columns>
                    <colgroup>
                        <ng-container *ngFor="let col of columns">
                            <ng-container *ngIf="col.visible">
                                <col [ngStyle]="{'width': col.width}">
                            </ng-container>
                        </ng-container>
                    </colgroup>
                </ng-template>
                <ng-template pTemplate="header" let-columns>
                    <tr>
                        <ng-container *ngFor="let col of columns">
                            <th *ngIf="col.visible" pResizableColumn [pSortableColumn]="col.field">
                                <ng-container *ngIf="col.type === 'selection'">
                                    <label nz-checkbox [(ngModel)]="allCheckedItems"
                                           (nzCheckedChange)="updateAllChecked($event)"
                                           [nzIndeterminate]="indeterminateItems"></label>
                                </ng-container>
                                <div style="white-space: nowrap;" *ngIf="!col.filtered">
                                    {{col.header}}
                                </div>

                                <div style="white-space: nowrap;"
                                     *ngIf="col.filtered && col.type !== 'icon' && col.type !== 'check'">
                                    {{col.header}}
                                    <p-sortIcon style="color: #848484 !important;" [field]="col.field"
                                                ariaLabel="Activate to sort"
                                                ariaLabelDesc="Activate to sort in descending order"
                                                ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
                                </div>
                                <div *ngIf="col.type === 'check'">
                                    <i [nzTitle]="col.header" nzPlacement="top" nz-tooltip style="font-size: 20px;"
                                       [ngClass]="col.icon"></i>
                                </div>
                            </th>
                        </ng-container>
                    </tr>
                    <tr>
                        <ng-container *ngFor="let col of columns">
                            <th *ngIf="col.type != 'selection'" pResizableColumn>
                                <div class="search-bar-table" *ngIf="col.filtered && col.type !== 'icon' && col.type !== 'check'">
                                    <i class="fa fa-search" style="margin: 6px 4px 4px 6px"></i>
                                    <input pInputText type="text"
                                           (input)="onFilter($event.target.value, col.field, col.filterMatchMode)">
                                </div>
                            </th>
                            <th *ngIf="col.type === 'selection'" pResizableColumn [pSortableColumn]="col.field">
                                <div style="white-space: nowrap;" >
                                    <p-sortIcon style="color: #848484 !important;"
                                                [field]="col.field"
                                                ariaLabel="Activate to sort"
                                                ariaLabelDesc="Activate to sort in descending order"
                                                ariaLabelAsc="Activate to sort in ascending order"></p-sortIcon>
                                </div>
                            </th>
                        </ng-container>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-i="rowIndex" let-rowData let-columns="columns">
                    <tr [pSelectableRow]="rowData" [pSelectableRowIndex]="i" [pContextMenuRow]="rowData" [ngClass]="{'frozenRow': rowData.isScanning}">
                        <ng-container *ngFor="let col of columns">
                            <th *ngIf="col.visible && !col.edit" class="ui-resizable-column"
                                [ngClass]="{'selected-item': rowData?.selected}">
                                <div class="" *ngIf="col.type === 'selection'">
                                    <label nz-checkbox
                                           (ngModelChange)="checkRow(rowData?.rlAnalysisId)"
                                           [ngModel]="rowData.selected"></label>
                                </div>
                                <div class="text-data" *ngIf="col.type === 'scan'" (click)="updateSelection(rowData?.rlAnalysisId)"><i class="icon-loop_24px"></i></div>
                                <div class="text-data" *ngIf="col.type === 'progress'" (click)="updateSelection(rowData?.rlAnalysisId)">
                                    <ng-container *ngIf="!rowData.isScanning; else scanning">
                                        <nz-progress [nzPercent]="100" [ngClass]="{'hidden-text': true }"
                                                     [nzWidth]="20" nzType="circle"></nz-progress>
                                    </ng-container>
                                    <ng-template #scanning>
                                        <!--                    <span class="loading">Scanning</span>-->
                                        <i style="color: #0CB79B" class="logo-right pi pi-spin pi-spinner"></i>
                                    </ng-template>
                                </div>
                                <div class="text-data" (click)="openFinancialP(rowData)"
                                     [ngClass]="{'highlight-temp': col.highlight}"
                                     *ngIf="col.type === 'multiple'">
                                    <span nz-tooltip [nzTitle]="infoFP"
                                          *ngIf="rowData?.financialPerspectives?.length > 1">M*</span>
                                    <span *ngIf="rowData?.financialPerspectives?.length === 1">{{rowData?.financialPerspectives[0]}}</span>
                                    <span *ngIf="rowData?.financialPerspectives?.length === 0">Nan</span>

                                    <!--                  <span nzPlacement="top" nz-tooltip-->
                                    <!--                        *ngIf="rowData?.financialPerspective?.length == 0">Nan</span>-->
                                    <ng-template #infoFP>
                                        <div class="popover-menu">
                                            <ul style="margin-bottom: 0">
                                                <li *ngFor="let item of rowData?.financialPerspectives"
                                                    style="border: none;">
                          <span style="display: flex; width: 100%;">
                            <span style="display: inline-flex; width: 23px;">{{item}}</span>: {{refs.financialPerspective[item]}}</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </ng-template>
                                </div>
                                <div class="text-data" (click)="updateSelection(rowData?.rlAnalysisId)"
                                     [ngClass]="{'highlight-temp': col.highlight}"
                                     *ngIf="col.type === 'number'">
                                    <input *ngIf="col.field=='unitMultiplier'; else formattedNumber" type="number"
                                           class="col-edit-input"
                                           [(ngModel)]="rowData[col.field]"
                                           (ngModelChange)="updateRowData(col.field, $event, rowData?.rlAnalysisId)">
                                    <ng-template #formattedNumber>
                                        <span>{{rowData[col.field] | number: '1.2-2'}}</span>
                                    </ng-template>
                                </div>
                                <div class="text-data" (click)="updateSelection(rowData?.rlAnalysisId)"
                                     [ngClass]="{'highlight-temp': col.highlight}"
                                     *ngIf="col.type === 'percentage'">
                                    <input *ngIf="col.field=='proportion'; else formattedNumber" type="number"
                                           class="col-edit-input"
                                           [(ngModel)]="rowData[col.field]"
                                           (ngModelChange)="updateRowData(col.field, $event,rowData?.rlAnalysisId)">
                                    <ng-template #formattedNumber>
                                        <span>{{rowData[col.field] | number: '1.2-2'}} % </span>
                                    </ng-template>

                                </div>
                                <div class="text-data" (click)="updateSelection(rowData?.rlAnalysisId)"
                                     [ngStyle]="{'font-weight': col.field === 'number' ? 'bold' : '500'}"
                                     [ngClass]="{'highlight-temp': col.highlight}"
                                     *ngIf="col.type === 'text'"><span>{{rowData[col.field]}}</span></div>
                                <div class="text-data" style="font-weight: 500"
                                     *ngIf="col.type === 'Rp' || col.type === 'Ob'"
                                     (click)="overrideRegionPerilOccurrenceBasis(rowData, col.type,i)">
                    <span class="highlighted-change">
                      {{rowData[col.field]}}
                    </span>
                                </div>
                                <div (click)="updateSelection(rowData?.rlAnalysisId)" *ngIf="col.type === 'division'"
                                     class="highlight-temp text-data">
                                    <span nz-tooltip
                                          [nzTitle]="DivisionInfo">{{rowData[col.field]?.length > 1 ? 'M*' : (rowData[col.field]?.length == 1 ? rowData[col.field][0] : '0') }}</span>
                                    <ng-template #DivisionInfo>
                                        <div class="popover-menu">
                                            <ul style="margin-bottom: 0">
                                                <ng-container *ngFor="let item of rowData[col.field]">
                                                    <li> Division N {{item}}</li>
                                                </ng-container>
                                            </ul>
                                        </div>
                                    </ng-template>
                                </div>
                                <div class="text-data" (click)="col.canOverride ? showOverridePEQTDialog=true : null"
                                     *ngIf="col.type === 'Peqt'">
                    <span [ngClass]="{'highlighted-change': col.canOverride}">
                      <span *ngIf=" (rowData.targetRaps||[]).length > 0; else noSelectedPeqts" nz-tooltip
                            [nzTitle]="peqtInfo">
                        {{rowData.targetRaps.length}}/{{rowData?.referenceTargetRaps?.length || 0}}
                      </span>
                      <ng-template #peqtInfo>
                        <div class="popover-menu">
                          <ul style="margin-bottom: 0">
                            <ng-container *ngFor="let item of rowData?.targetRaps">
                              <li>{{item.targetRapCode}}</li>
                            </ng-container>
                          </ul>
                        </div>
                      </ng-template>
                    </span>
                                    <ng-template #noSelectedPeqts>
                      <span>
                         0/{{rowData?.referenceTargetRaps?.length || 0}} <i class="icon-exclamation-triangle"></i>
                      </span>
                                    </ng-template>
                                </div>
                                <div class="text-data" [ngClass]="{'highlight-temp': col.highlight}"
                                     *ngIf="col.type === 'date'"><span>{{rowData[col.field] | date:'dd/MM/yyyy'}}</span>
                                </div>
                                <div style="padding-left: 10px;" *ngIf="col.type === 'check'">
                                    <label nz-checkbox [(ngModel)]="rowData[col.field]"></label>
                                </div>
                            </th>
                            <ng-container *ngIf="col.edit">
                                <th pEditableColumn *ngIf="col.field === 'targetCurrency'"
                                    [ngClass]="{'selected-item': rowData?.selected}">
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <nz-select
                                                    style="width: 100%"
                                                    (ngModelChange)="updateRowData(col.field, $event, rowData?.rlAnalysisId)"
                                                    [ngModel]="rowData.targetCurrency"
                                                    nzShowSearch
                                                    class="a-dropdown-small input-wrapper"
                                                    nzPlaceHolder="TAG CURRENCY"
                                            >
                                                <nz-option *ngFor="let c of refs?.currencies" [nzLabel]="c.label"
                                                           [nzValue]="c.value"></nz-option>
                                            </nz-select>
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            <div class="text-data highlight-temp">
                                                <span>{{rowData.targetCurrency}}</span></div>
                                        </ng-template>
                                    </p-cellEditor>
                                </th>
                                <!--                <th pEditableColumn *ngIf="col.field === 'targetRap'"-->
                                <!--                    [ngClass]="{'selected-item': rowData?.selected}">-->
                                <!--                  <p-cellEditor>-->
                                <!--                    <ng-template pTemplate="input">-->
                                <!--                      <nz-select-->
                                <!--                        style="width: 100%"-->
                                <!--                        (ngModelChange)="updateTargetRap($event, rowData)"-->
                                <!--                        [ngModel]="rowData.targetRap"-->
                                <!--                        nzShowSearch-->
                                <!--                        class="a-dropdown-small input-wrapper"-->
                                <!--                        nzPlaceHolder="TAG TARGET RAP CODE"-->
                                <!--                      >-->
                                <!--                        <nz-option *ngFor="let tr of refs?.targetRaps" [nzLabel]="tr" [nzValue]="tr"></nz-option>-->
                                <!--                      </nz-select>-->
                                <!--                    </ng-template>-->
                                <!--                    <ng-template pTemplate="output">-->
                                <!--                      <div class="text-data highlight-temp"><span>{{rowData.targetRap}}</span></div>-->
                                <!--                    </ng-template>-->
                                <!--                  </p-cellEditor>-->
                                <!--                </th>-->
                            </ng-container>
                        </ng-container>
                    </tr>
                </ng-template>
            </p-table>
        </div>
        <div *ngIf="!isCollapsed" class="button-container">
            <button (click)="saveAnalysisSelection()" class="a-buttons-contained-mini">SAVE</button>
        </div>
    </div>
    <p-contextMenu appendTo="body" #cmR [model]="itemCm"></p-contextMenu>
</div>

<override-region-peril-dialog *ngIf="showOverrideRpDialog" [visible]="showOverrideRpDialog" [data]="data.analysis"
                              [regionPerilByAnalysis]="data.regionPerilsByAnalysis"
                              (close)="showOverrideRpDialog=false"
                              (override)="overrideRegionPeril($event)">
</override-region-peril-dialog>


<financial-persp-selection-dialog *ngIf="showSelectFinancialPerspDialog" [visible]="showSelectFinancialPerspDialog"
                                  [data]="data" [context]="context" (close)="showSelectFinancialPerspDialog=false"
                                  (loadEpCurves)="loadSourceEpCurveHeaders($event)"
                                  (override)="overrideFinancialPersp($event)"
></financial-persp-selection-dialog>

<override-peqt-dialog *ngIf="showOverridePEQTDialog" [visible]="showOverridePEQTDialog"
                      [data]="{analysis: data.analysis, targetRaps: data.targetRaps}"
                      (loadTargetRaps)="loadTargetRaps($event)" (override)="overridePEQTs($event)"
                      (close)="closePEQTOverrideDialog()">
</override-peqt-dialog>


<override-occurence-basis-dialog [visible]="showOverrideOccurrenceBasisDialog"
                                 (override)="overrideOccurrenceBasis($event)"
                                 (close)="showOverrideOccurrenceBasisDialog=false">

</override-occurence-basis-dialog>

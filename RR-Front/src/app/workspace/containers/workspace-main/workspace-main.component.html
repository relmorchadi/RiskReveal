<div class="card-container">
  <nz-tabset
    *ngIf="!loading"
    [nzSelectedIndex]="selectedTabIndex"
    [nzTabPosition]="'top'"
    [nzType]="'card'"
    class="tabs-main-component">
    <ng-container *ngFor="let wsIdentifier of data | keys;let k= index;">
      <ng-template #titleTemplate>
        <ng-container
          [ngTemplateOutlet]="tabTitle"
          [ngTemplateOutletContext]="{
            title: data[wsIdentifier]?.cedantName,
            workspaceName: data[wsIdentifier]?.workspaceName,
            workSpaceId: data[wsIdentifier]?.wsId,
            year: data[wsIdentifier]?.uwYear,
            years: data[wsIdentifier]?.years,
            index: k,
            wsIdentifier: wsIdentifier
          }"
        ></ng-container>
      </ng-template>

      <nz-tab (nzSelect)="selectWorkspace(wsIdentifier,k)" [nzTitle]="titleTemplate">
        <ng-template nz-tab>
        <div nz-row>
          <div nz-col nzSpan="24">
            <div class="row tab-detail p-2 header-tab-wrapper">
              <div class="detail-wrapper">
                <button (click)="patchWorkspaceDetail(wsIdentifier)"
                        class="ml-4 mr-3 btn-detail d-flex justify-content-center align-items-center"
                        nz-button nzType="primary" nzSize="default" nzShape="circle">
                  <i *ngIf="data[wsIdentifier]?.collapseWorkspaceDetail" nz-icon style="color: #16617a;font-size: 14px;"
                     type="down"
                     theme="outline"></i>
                  <i *ngIf="!data[wsIdentifier]?.collapseWorkspaceDetail" nz-icon
                     style="color: #16617a;font-size: 14px;" type="up"
                     theme="outline"></i>
                </button>
                <span *ngIf="data[wsIdentifier]?.collapseWorkspaceDetail" class="span-detail">Detail</span>
                <span *ngIf="!data[wsIdentifier]?.collapseWorkspaceDetail" class="span-detail">Hide</span>
              </div>
              <div style="display: flex; flex: 1;">
                <div class="workspace-title-wrapper">
                  <div class="d-inline-flex flex-column">
                    <h3 class="workspace-title"
                        [ngClass]="{'fac-title': data[wsIdentifier]?.workspaceType === 'fac'}">
                      {{data[wsIdentifier]?.cedantName}}
                      <i (click)="toggleFavorite(wsIdentifier, data[wsIdentifier])"
                         *ngIf="!data[wsIdentifier].isFavorite; else favoriteIcon" class="icon-star_border_24px"></i>
                      <ng-template #favoriteIcon>
                        <i (click)="toggleFavorite(wsIdentifier, data[wsIdentifier])" class="icon-star_24px"></i>
                      </ng-template>
                    </h3>
                    <h4 class="workspace-title" [ngClass]="{'fac-title': data[wsIdentifier]?.workspaceType === 'fac'}">
                      {{data[wsIdentifier]?.workspaceName}} | {{data[wsIdentifier]?.uwYear}} | {{data[wsIdentifier]?.wsId}}
                    </h4>
                    <span style="display: flex; align-items: center" *ngIf="data[wsIdentifier]?.workspaceType === 'fac'">
                      <span [ngClass]="{'fac-title': data[wsIdentifier]?.workspaceType === 'fac'}"
                            class="tab-metadata-title">Selected Project:</span>
                      <span>
                        <nz-dropdown [nzTrigger]="'click'">
                          <a nz-dropdown>
                            <span class="d-flex align-items-center">
                              <span class="dropdown-project-style">
                                <ng-container *ngIf="selectedPrj?.projectType === 'FAC'">
                                  {{selectedPrj?.projectName}} [{{selectedPrj?.projectId}}] - {{selectedPrj?.carRequestStatus}}
                                </ng-container>
                                <ng-container *ngIf="selectedPrj?.projectType === 'TREATY'">
                                  {{selectedPrj?.projectName}} [{{selectedPrj?.projectId}}] - Manual
                                </ng-container>
                              </span>
                              <span class="d-flex">
                                 <i class="pl-3 drop-icon" *ngIf="filterListProject().length > 0"
                                    style="font-size: 12px; margin: 0 !important;" nz-icon type="down"></i>
                              </span>
                            </span>
                          </a>
                          <ul style="padding:0; max-height: 250px; overflow: auto" *ngIf="filterListProject().length > 0 && wsStatus === 'fac'" nz-menu>
                            <li (click)="selectProject(item.projectId)" *ngFor="let item of filterListProject()" nz-menu-item>
                              <ng-container *ngIf="item.projectType === 'FAC'">
                                {{item?.carRequestId}} [{{item?.projectId}}] - {{item?.carRequestStatus}}
                                <!--| trimSecondaryFormat-->
                              </ng-container>
                              <ng-container *ngIf="item.projectType === 'TREATY'">
                                {{item?.projectName}} [{{item?.projectId}}] - Manual
                              </ng-container>
                            </li>
                          </ul>
                        </nz-dropdown>
                      </span>
                    </span>
                  </div>
                </div>
                <div [ngClass]="{'collapse':!data[wsIdentifier]?.collapseWorkspaceDetail}" class="header-tab-right">
                  <div nzTitle="Scope" nzPlacement="bottom" nz-tooltip
                       class="text-center my-2 px-4 d-inline-flex flex-column">
                    <i style="font-size: 1.6em" class="icon-location_searching_24px mb-2"></i>
                    <span><b>{{data[wsIdentifier]?.expectedRegionPerils}}</b></span>
                  </div>
                  <div nzTitle="Exposures" nzPlacement="bottom" nz-tooltip
                       class="text-center my-2 px-4 d-inline-flex flex-column">
                    <i style="font-size: 1.6em" class="icon-adjust-half mb-2"></i>
                    <span><b>{{data[wsIdentifier]?.expectedExposureSummaries}}</b></span>
                  </div>
                  <div nzTitle="Qualifying PLTs" nzPlacement="bottom" nz-tooltip
                       class="text-center my-2 px-4 d-inline-flex flex-column">
                    <i style="font-size: 1.6em" class="icon-box mb-2"></i>
                    <span><b>{{data[wsIdentifier]?.qualifiedPLTs}}</b></span>
                  </div>
                  <div nzTitle="Published For Pricing" nzPlacement="bottom" nz-tooltip
                       class="text-center my-2 px-4 d-inline-flex flex-column">
                    <i style="font-size: 1.6em" class="icon-note mb-2"></i>
                    <span><b>{{data[wsIdentifier]?.expectedPublishedForPricing}}</b></span>
                  </div>
                  <div nzTitle="Priced" nzPlacement="bottom" nz-tooltip
                       class="text-center my-2 px-4 d-inline-flex flex-column">
                    <i style="font-size: 1.6em" class="icon-dollar-alt mb-2"></i>
                    <span><b>{{data[wsIdentifier]?.expectedPriced}}</b></span>
                  </div>
                  <div nzTitle="Published For Accumulation" nzPlacement="bottom" nz-tooltip
                       class="text-center my-2 px-4 d-inline-flex flex-column">
                    <i style="font-size: 1.6em" class="icon-focus-add mb-2"></i>
                    <span><b>{{data[wsIdentifier]?.expectedAccumulation}}</b></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div [ngClass]="{'collapse':data[wsIdentifier]?.collapseWorkspaceDetail}">
            <div class="tab-detail workspace-menu-header-wrapper" style="padding-bottom: 1rem !important;">

              <div class="flex-horizontal-sb-layout workspace-menu-header-left">
                <div style="padding-top:0px !important;" class="full-width-flex">
                  <div style="width: 40%">
                    <div class="item-workspace-info full-width-flex">
                      <span style="flex: 0 0 45.333333%;" class="tab-metadata-title">Subsidary :</span>
                      <span *ngIf="wsStatus === 'treaty'" class="tab-metadata-value text-wrap-ellipsis">
                        {{data[wsIdentifier]?.subsidiaryId}} - {{data[wsIdentifier]?.subsidiaryName}}</span>
                      <span *ngIf="wsStatus === 'fac'" class="tab-metadata-value text-wrap-ellipsis">
                        {{selectedPrj?.subsidiary}} - {{selectedPrj?.subsidiaryName}}</span>
                    </div>
                    <div class="item-workspace-info full-width-flex">
                      <span style="flex: 0 0 45.333333%;" class="tab-metadata-title">Subsidary Ledger :</span>
                      <span *ngIf="wsStatus === 'treaty'" class="tab-metadata-value text-wrap-ellipsis">
                        {{data[wsIdentifier]?.subsidiaryLedgerId}} - {{data[wsIdentifier]?.ledgerName}}</span>
                      <span *ngIf="wsStatus === 'fac'" class="tab-metadata-value text-wrap-ellipsis">
                        {{data[wsIdentifier]?.ledgerName}}</span>
                    </div>
                    <div class="item-workspace-info full-width-flex">
                        <span style="flex: 0 0 45.333333%;" class="tab-metadata-title">Contract Source :</span>
                      <span *ngIf="wsStatus === 'treaty'" class="tab-metadata-value text-wrap-ellipsis">
                        {{data[wsIdentifier]?.contractDatasource}}</span>
                      <span *ngIf="wsStatus === 'fac'" class="tab-metadata-value text-wrap-ellipsis">
                        {{selectedPrj?.contractDatasource}}</span>
                    </div>
                  </div>
                  <div class="flex-horizontal-sb-layout workspace-treaty-date-wrapper">
                    <div style="display:flex; width: 40%">
                      <i class="icon-calendar-alt mb-4"></i>
                      <div class="workspace-date-menu flex-vertical-layout">
                        <span class="d-block tab-metadata-title">Inception Date :</span>
                        <span
                          class="d-block tab-metadata-value">{{data[wsIdentifier]?.inceptionDate | date:'dd/MM/yyyy'}}</span>
                        <span class="d-block tab-metadata-title">Expiry Date :</span>
                        <span
                          class="d-block tab-metadata-value">{{data[wsIdentifier]?.expiryDate | date:'dd/MM/yyyy'}}</span>
                      </div>
                    </div>
                    <div  style="border-left: 1px solid rgba(255,255,255,0.5); width: 60%;" class="flex-vertical-layout"
                          *ngIf="wsStatus === 'treaty'">
                      <span style="line-height: 17px; padding: 0 0 6px 15px" class="tab-metadata-title">Treaty Section :</span>
                      <ul class="treaty-list">
                        <li
                          *ngFor="let section of sliceContent(data[wsIdentifier]?.treatySections, state?.sliceValidator)">
                          {{section}}
                        </li>
                      </ul>
                      <ng-container *ngIf="data[wsIdentifier]?.treatySections?.length > 2">
                        <span (click)="patchSliceValue(false)" *ngIf="state?.sliceValidator" class="tab-metadata-more">See All</span>
                        <span (click)="patchSliceValue(true)" *ngIf="!state?.sliceValidator" class="tab-metadata-more">Hide</span>
                      </ng-container>
                    </div>
                    <div style="border-left: 1px solid rgba(255,255,255,0.5); width: 60%;" class="flex-vertical-layout"
                         *ngIf="wsStatus === 'fac'">
                      <span style="line-height: 17px; padding: 0 0 6px 15px" class="tab-metadata-title">Division :</span>
                      <ul class="treaty-list" style="padding-left: 20px;">
                        <li *ngFor="let division of selectedPrj?.divisions">
                          Division NÂ°{{division}}
                        </li>
                      </ul>
                      <ng-container *ngIf="data[wsIdentifier]?.treatySections?.length > 2">
                        <span (click)="patchSliceValue(false)" *ngIf="state?.sliceValidator" class="tab-metadata-more">See All</span>
                        <span (click)="patchSliceValue(true)" *ngIf="!state?.sliceValidator" class="tab-metadata-more">Hide</span>
                      </ng-container>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex-vertical-layout workspace-menu-header-right">
                <h5 class="tab-kpi-title">In Scope Region Perils</h5>
                <div class="d-flex">
                  <div style="flex:1" class="flex-vertical-layout justify-content-end number-workspace-info">
                    <i style="font-size: 1.6em" class="icon-location_searching_24px mb-3"></i>
                    <span style="flex:1;" class="d-flex align-items-start mb-1 kpi-icon-title">Region Perils</span>
                    <span class="kpi-icon-value">{{data[wsIdentifier]?.expectedRegionPerils}}</span>
                  </div>
                  <div style="flex:1" class="flex-vertical-layout justify-content-end number-workspace-info">
                    <i style="font-size: 1.6em" class="icon-adjust-half mb-3"></i>
                    <span style="flex:1;" class="d-flex align-items-start mb-1 kpi-icon-title">Exposures</span>
                    <span class="kpi-icon-value">{{data[wsIdentifier]?.expectedExposureSummaries}}</span>
                  </div>
                  <div style="flex:1" class="flex-vertical-layout justify-content-end number-workspace-info">
                    <i style="font-size: 1.6em" class="icon-box mb-3"></i>
                    <span style="flex:1;" class="d-flex align-items-start mb-1 kpi-icon-title">Qualifying PLTs</span>
                    <span class="kpi-icon-value">{{data[wsIdentifier]?.qualifiedPLTs}}</span>
                  </div>
                  <div style="flex:1" class="flex-vertical-layout justify-content-end number-workspace-info">
                    <i style="font-size: 1.6em" class="icon-note mb-3"></i>
                    <span style="flex:1;"
                          class="d-flex align-items-start mb-1 kpi-icon-title">Published For Pricing</span>
                    <span class="kpi-icon-value">{{data[wsIdentifier]?.expectedPublishedForPricing}}</span>
                  </div>
                  <div style="flex:1" class="flex-vertical-layout justify-content-end number-workspace-info">
                    <i style="font-size: 1.6em" class="icon-dollar-alt mb-3"></i>
                    <span style="flex:1;" class="d-flex align-items-start mb-1 kpi-icon-title">Priced</span>
                    <span class="kpi-icon-value">{{data[wsIdentifier]?.expectedPriced}}</span>
                  </div>
                  <div style="flex:1" class="flex-vertical-layout justify-content-end number-workspace-info">
                    <i style="font-size: 1.6em" class="icon-focus-add mb-3"></i>
                    <span style="flex:1;" class="d-flex align-items-start mb-1 kpi-icon-title">Published For Accumulation</span>
                    <span class="kpi-icon-value">{{data[wsIdentifier]?.expectedAccumulation}}</span>
                  </div>
                </div>
              </div>

            </div>
          </div>
          <div [nzSpan]="24" nz-col>
            <div style="display: flex">
              <workspace-router (action)="dispatch($event)"
                                [state]="{wsIdentifier: wsIdentifier , data: data[wsIdentifier]}"></workspace-router>
              <!-- <app-left-menu [isCollapsed]="data[wsIdentifier]?.leftNavbarCollapsed" (navigate)="leftMenuNavigation($event, data[wsIdentifier])" (toggleCollapse)="toggleLeftMenu(wsIdentifier)" ></app-left-menu>-->
              <!-- <router-outlet></router-outlet> -->
            </div>
          </div>
        </div>
        </ng-template>
      </nz-tab>
    </ng-container>
  </nz-tabset>
</div>

<ng-template
  let-title='title'
  let-name="workspaceName"
  let-workSpaceId="workSpaceId"
  let-index="index"
  let-wsIdentifier="wsIdentifier"
  let-year='year'
  let-years='years'
  #tabTitle>
  <div class="tab-title-container pl-3">
    <ng-container *ngIf="!loading">
      <div class="tab-title">
        <span class="tab-title-main">{{title}}</span>
        <span class="tab-title-sub" [nz-tooltip]="name" nzPlacement="bottom">{{name}}</span>
      </div>
      <nz-dropdown [nzTrigger]="'click'">
        <a nz-dropdown>
          <h6 class="d-flex align-items-center sub-title">
            {{year}}
            <i class="pl-3 drop-icon" *ngIf="generateYear(year, years, workSpaceId).length >0" nz-icon type="down"></i>
          </h6>
        </a>
        <ul style="padding:0" nz-menu>
          <li (click)="addWs(workSpaceId, y)" *ngFor="let y of generateYear(year, years, workSpaceId)"
              nz-menu-item>{{y}}</li>
        </ul>
      </nz-dropdown>
      <i (click)="close(workSpaceId, year)" class="icon-clear_24px"></i>
    </ng-container>
    <ng-container *ngIf="loading">
      <nz-skeleton class="skeleton-title-header"></nz-skeleton>
    </ng-container>
  </div>
</ng-template>
